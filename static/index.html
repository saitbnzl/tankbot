<!-- static/index.html -->
<!DOCTYPE html>
<html>
<head>
  <title>TankBot Brain</title>
  <meta charset="utf-8">
  <style>
    body {
      margin:0;
      font-family: system-ui;
      background:#0b1020;
      color:white;
      padding:20px;
    }
    h1 { margin-bottom: 4px; }
    .subtitle { opacity:0.7; margin-bottom: 16px; }

    /* LAYOUT */
    .layout {
      display:flex;
      gap:16px;
      align-items:flex-start;
    }
    .left-column {
      flex: 2;
      min-width: 0;
    }
    .right-column {
      flex: 1;
      min-width: 260px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    @media (max-width: 900px) {
      .layout {
        flex-direction: column;
      }
      .right-column {
        flex-direction: column;
        min-width: 0;
      }
    }

    /* CARDS */
    .card {
      background: #12172b;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.4);
    }
    .card-title {
      font-weight: 600;
      margin-bottom: 8px;
    }
    .small { font-size: 12px; opacity: 0.8; }

    /* STATUS PILLS */
    .status-row {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .status-pill {
      display:flex;
      align-items:center;
      gap:8px;
      background:#222a48;
      padding:6px 10px;
      border-radius: 20px;
      width: fit-content;
      font-size: 12px;
    }
    .status-pill .dot {
      width:10px;
      height:10px;
      border-radius:50%;
      background:red;
    }
    .status-pill.online .dot { background:#0f0; }
    .status-pill.offline .dot { background:#900; }

    /* VIDEO */
    .video-container {
      background:#000;
      border-radius:6px;
      overflow:hidden;
    }
    .video-container img {
      display:block;
      width:100%;
      max-height:520px;
      object-fit:contain;
    }

    /* MODES BUTTONS */
    .modes-buttons {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:6px;
    }
    .modes-buttons button {
      padding:6px 10px;
      border-radius:4px;
      border:none;
      cursor:pointer;
      font-size:13px;
      background:#1f2744;
      color:white;
    }
    .modes-buttons button:hover {
      background:#283258;
    }

    /* ---------------------- GAMEPAD VISUAL ---------------------- */
    .cmd-wrapper {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .cmd-display {
      width: 120px;
      height: 120px;
      position: relative;
      margin: 4px 0;
    }
    .cmd-display div {
      position: absolute;
      width: 40px;
      height: 40px;
      font-size: 18px;
      text-align: center;
      line-height: 40px;
      opacity: 0.15;
      transition: 0.15s ease;
    }
    .cmd-up    { top: 0; left: 40px; scale: 1.5;}
    .cmd-left  { top: 40px; left: 0; scale: 1.5;}
    .cmd-stop  { top: 40px; left: 40px; scale: 1.5; }
    .cmd-right { top: 40px; left: 80px;  scale: 1.5; }
    .cmd-down  { top: 80px; left: 40px;  scale: 1.5; }

    .cmd-active {
      opacity: 1;
      color: #fd0000;
      transform: scale(1.2);
    }

  </style>
</head>
<body>
  <h1>TankBot Brain</h1>
  <div class="subtitle">Raspberry Pi 5 Vision &amp; Control</div>

  <div class="layout">
    <!-- LEFT: BIG VIDEO -->
    <div class="left-column">
      <div class="card">
        <div class="card-title">Live YOLO View</div>
        <div class="video-container">
          <img src="/video">
        </div>
        <div class="small">If this is blank, check ESP32-CAM stream.</div>
      </div>
    </div>

    <!-- RIGHT: STATUS + MODES + D-PAD -->
    <div class="right-column">
      <div class="card">
        <div class="card-title">Status</div>
        <div class="status-row">
          <div id="video-status" class="status-pill offline">
            <div class="dot"></div>
            <span>Video: offline</span>
          </div>
          <div id="tankbot-status" class="status-pill offline">
            <div class="dot"></div>
            <span>TankBot: offline</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Modes</div>
        <div class="modes-buttons">
          <button id="person-start">Start Person Follow</button>
          <button id="person-stop">Stop Person Follow</button>
        </div>
        <div id="person-status" class="small">Mode: idle</div>
      </div>

      <div class="card">
        <div class="card-title">Last Command</div>
        <div class="cmd-wrapper">
          <div class="cmd-display">
            <div id="cmd-up" class="cmd-up">↑</div>
            <div id="cmd-left" class="cmd-left">←</div>
            <div id="cmd-stop" class="cmd-stop">⏺</div>
            <div id="cmd-right" class="cmd-right">→</div>
            <div id="cmd-down" class="cmd-down">↓</div>
          </div>
          <div class="small" id="last-cmd-label">
            Waiting for commands…
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card" style="max-width:680px; width:100%; margin-top:16px;">
  <div class="card-title">Person Follow Hyperparameters</div>

  <label>Forward Speed:
    <input type="range" min="10" max="100" value="55"
           id="cfg_forward_speed">
    <span id="cfg_forward_speed_val">55</span>
  </label><br>

  <label>Turn Speed:
    <input type="range" min="10" max="100" value="40"
           id="cfg_turn_speed">
    <span id="cfg_turn_speed_val">40</span>
  </label><br>

  <label>Center Deadzone:
    <input type="range" min="0" max="0.4" step="0.01" value="0.15"
           id="cfg_deadzone">
    <span id="cfg_deadzone_val">0.15</span>
  </label><br>

  <button id="cfg_save_btn">Save Settings</button>
  <div id="cfg_save_status" class="small">Not saved yet</div>
</div>

<script>
async function saveCfg(key, value) {
  await fetch("/config/update", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ key, value })
  });
}

document.getElementById("cfg_save_btn").onclick = async () => {
  const fwd = document.getElementById("cfg_forward_speed").value;
  const turn = document.getElementById("cfg_turn_speed").value;
  const dz = document.getElementById("cfg_deadzone").value;

  await saveCfg("FORWARD_SPEED", parseInt(fwd));
  await saveCfg("TURN_SPEED", parseInt(turn));
  await saveCfg("CENTER_DEADZONE", parseFloat(dz));

  document.getElementById("cfg_save_status").textContent = "Saved!";
};

document.getElementById("cfg_forward_speed").oninput = (e) =>
  document.getElementById("cfg_forward_speed_val").textContent = e.target.value;

document.getElementById("cfg_turn_speed").oninput = (e) =>
  document.getElementById("cfg_turn_speed_val").textContent = e.target.value;

document.getElementById("cfg_deadzone").oninput = (e) =>
  document.getElementById("cfg_deadzone_val").textContent = e.target.value;
</script>


  <!-- CONTROL JS -->
  <script>
    async function postJson(url) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: "{}"
      });
      if (!res.ok) throw new Error("HTTP " + res.status);
      return res.json();
    }

    document.getElementById("person-start").onclick = async () => {
      try {
        await postJson("/person_follow/start");
        document.getElementById("person-status").textContent =
          "Mode: person-follow (running)";
      } catch (e) {
        document.getElementById("person-status").textContent =
          "Mode: error starting (" + e.message + ")";
      }
    };

    document.getElementById("person-stop").onclick = async () => {
      try {
        await postJson("/person_follow/stop");
        document.getElementById("person-status").textContent = "Mode: idle";
      } catch (e) {
        document.getElementById("person-status").textContent =
          "Mode: error stopping (" + e.message + ")";
      }
    };
  </script>

  <!-- STATUS + GAMEPAD JS -->
  <script>
    function updateGamepad(cmd, speed) {
      document.querySelectorAll(".cmd-display div")
        .forEach(el => el.classList.remove("cmd-active"));

      if (cmd === "forward")  document.getElementById("cmd-up").classList.add("cmd-active");
      if (cmd === "left")     document.getElementById("cmd-left").classList.add("cmd-active");
      if (cmd === "right")    document.getElementById("cmd-right").classList.add("cmd-active");
      if (cmd === "backward") document.getElementById("cmd-down").classList.add("cmd-active");
      if (cmd === "stop")     document.getElementById("cmd-stop").classList.add("cmd-active");

      const label = document.getElementById("last-cmd-label");
      label.textContent = `Last: ${cmd} @ ${speed}`;
    }

    function setStatus(id, online) {
      const el = document.getElementById(id);
      const span = el.querySelector("span");
      el.classList.remove("online", "offline");
      el.classList.add(online ? "online" : "offline");

      if (id === "video-status") {
        span.textContent = "Video: " + (online ? "online" : "offline");
      } else if (id === "tankbot-status") {
        span.textContent = "TankBot: " + (online ? "online" : "offline");
      }
    }

    async function refreshStatus() {
      try {
        const res = await fetch("/status", { cache: "no-store" });
        const data = await res.json();

        // backend: { latest_frame: "ok"|"none", last_command: {cmd, speed} }
        setStatus("video-status", data.latest_frame === "ok");
        // very simple: if status endpoint works, assume tankbot reachable
        setStatus("tankbot-status", true);

        if (data.last_command && data.last_command.cmd) {
          updateGamepad(data.last_command.cmd, data.last_command.speed ?? 0);
        }
      } catch (e) {
        setStatus("video-status", false);
        setStatus("tankbot-status", false);
      }
    }

    refreshStatus();
    setInterval(refreshStatus, 250);
  </script>
</body>
</html>
